{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-02-21-deploy-to-azure/2021-02-21-deploy-to-azure-app-services/","result":{"data":{"site":{"siteMetadata":{"title":"Effective Coding"}},"markdownRemark":{"id":"eaae743d-0ba5-52d1-a7e1-57ed2be2762d","excerpt":"Introduction Le cloud prend de plus en plus de place pour le développement d’applications. Nous allons voir dans ce post comment déployer une application Spring…","html":"<h2>Introduction</h2>\n<p>Le cloud prend de plus en plus de place pour le développement d’applications. Nous allons voir dans ce post comment déployer une application Spring Boot toute simple et bien connue, <em>PetClinic</em>, avec les GitHub actions!</p>\n<h2>Déclaration de notre application dans Azure App Services</h2>\n<h3>Création de l’instance</h3>\n<p>Dans Azure, il faut tout d’abord créer une nouvelle instance d’application <em>App Services</em>.\nDans le menu <em>App Services</em> cliquez sur <em>Add</em>. Vous arrivez sur cet écran :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/2a301da06fd2e10cccc282962f592d13/27b7a/appservices.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.79746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABOUlEQVR42qVS25bCIAz0/79Td7VabuUaoLMBrdQ97svK6ZxQAsNMyOGqLCahcbzpHlOM+GQcpJhxPn/jOp1xOh0xz/NnhEYbSCmxLMtLotaK4AMoEda6vgX4a1jXdRA65xDZZiNoiS2ZY4a4SFjlkX0B+XyHGzDCQkwSejbPc4cQWMWbujlaYUNCCB7t0mUxPe4H5YxECZnjU6H3HtZaFLovbuoTKzTSdlXJE0fq8xwGSiyMCuL5dq4rNFy/Rry/qZFcTzd4ttzsJctY6AVxYQcmwuswCL13UFpBKYlMNCynCmU4JyTnNCLb/+txaqnDsja6vzAx2f61fMqYZsF1s129ezigTH1vQ/svpbzWsC2sddywcWpHOH5dILhPtdYditurxdZmQgi0ctX6i7A9iFaqb6w7hf9t7B+dzl9SINbCmAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"App Service\"\n        title=\"\"\n        src=\"/blog/static/2a301da06fd2e10cccc282962f592d13/f058b/appservices.png\"\n        srcset=\"/blog/static/2a301da06fd2e10cccc282962f592d13/c26ae/appservices.png 158w,\n/blog/static/2a301da06fd2e10cccc282962f592d13/6bdcf/appservices.png 315w,\n/blog/static/2a301da06fd2e10cccc282962f592d13/f058b/appservices.png 630w,\n/blog/static/2a301da06fd2e10cccc282962f592d13/27b7a/appservices.png 804w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Il faut indiquer les informations suivantes :</p>\n<ul>\n<li><em>ressource-group</em>: créez en un si non existant;</li>\n<li><em>Name</em> : donner un nom à votre Application <em>App Services</em> (ne doit pas dejà exister)</li>\n<li><em>Publish</em> : indiquer <em>code</em>. Pour l’instant on déploie directement du code et on laisse Azure gérer. On verra dans un autre post comment faire via une image Docker, et les avantages que cela apporte</li>\n<li><em>Runtime Stack</em> : indiquer la version de JAVA. Nous c’est du <em>Java 11</em></li>\n<li><em>Stack</em> : Vérifier la version du Tomcat embarqué par l’appli Spring-Boot (via la version utilisée de Spring-Boot), mais si c’est la dernière version, ça sera certainement du Tomcat 9 (au moment de l’écriture du post);</li>\n<li><em>OS</em> : Linux, je n’ai pas testé Windows;</li>\n<li><em>Region</em> : le plus proche de chez vous :)</li>\n</ul>\n<h3>Configuration requise pour Linux!</h3>\n<p>Tel qu’indiqué <a href=\"https://docs.microsoft.com/fr-fr/azure/app-service/deploy-github-actions?tabs=applevel\">ici</a>, il est important si vous choisissez <em>Linux</em> dans l’étape précédente, d’ajouter une configuration spécifique  dans Azure.\nDans la nouvelle instance <em>App Services</em> que vous venez de créer, cliquez sur <em>Configuration</em>, vous arriverez sur cet écran :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/4bbd840b3ccdd037c5cbced731401272/7830c/azure-conf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.24050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABNElEQVR42p2S207DMBBE8//fyEMFFIVcfMs6viUdZt1SISHxgKUjx/Z6PLPKMEnFuFh8Ehc2bNuG4zzxn3G73TAYSZjnCUKhnBNCiIiyI6eCtGeUXJ/UcqDV8xfHA60ZvGQ475FLQW0NH68TLi9veL+MMFPAOvmOmQM2myG+IBJxxHPtHnDPr5EOjcGyzHQT4Z2DtYzuLYxZEbbQW6DotyJRsInu8SzuSN0IqYWmMgahkAp6utxjRBChIJ0tKy9GpJRYqJEzTvZW+/ST87zPOmqtKrh3seM4Ot1NCIgUzxSJe6KTTCetI3SXUkZjrZ47JtI77WjQtIOJCZZR9RUV1MjX6xXjOMJTWLHOP9HH9cHvVggTqbCi6yEy0jxN7OGOwn6oM521QCPcKWit9v3zj1+qtYYv62xs7dc3zPYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"App Service\"\n        title=\"\"\n        src=\"/blog/static/4bbd840b3ccdd037c5cbced731401272/f058b/azure-conf.png\"\n        srcset=\"/blog/static/4bbd840b3ccdd037c5cbced731401272/c26ae/azure-conf.png 158w,\n/blog/static/4bbd840b3ccdd037c5cbced731401272/6bdcf/azure-conf.png 315w,\n/blog/static/4bbd840b3ccdd037c5cbced731401272/f058b/azure-conf.png 630w,\n/blog/static/4bbd840b3ccdd037c5cbced731401272/40601/azure-conf.png 945w,\n/blog/static/4bbd840b3ccdd037c5cbced731401272/78612/azure-conf.png 1260w,\n/blog/static/4bbd840b3ccdd037c5cbced731401272/7830c/azure-conf.png 1345w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Cliquer sur  <em>New application Setting</em> puis indiquez :\n<em>WEBSITE_WEBDEPLOY_USE_SCM = true</em></p>\n<h3>Mise en place des Github Actions</h3>\n<p>Dans le repo Github que vous souhaitez déployer, il faut procéder à quelques manipulations. Il faut tout d’abord créer un secret pour connexion à Azure, puis mettre en place un workflow, contenant nos action Github pour compiler et déployer dans Azure.</p>\n<h3>Création du secret</h3>\n<p>Dans Azure :</p>\n<ul>\n<li>Cliquez sur votre instance d’App Service créee à la première étape;</li>\n<li>Cliquez sur <em>Get Publish Profile</em>;</li>\n<li>Télécharger le fichier;</li>\n</ul>\n<p>Dans Github :</p>\n<ul>\n<li>Cliquez sur votre repository, puis <em>Settings</em></li>\n<li>Cliquez Sur <em>Secrets</em> puis <em>New reposirory Secret</em></li>\n<li>Indiquez la clé <em>AZURE_WEBAPP_PUBLISH_PROFILE</em> avec en valeur le contenu du fichier de profile téléchargé ci-dessus;</li>\n</ul>\n<h3>Mise en place des Actions Github</h3>\n<p>On souhaite automatiquement compiler et déployer notre application dans Azure via un <em>workflow</em> Github.\nPour cela, il faut créer un fichier <em>yml</em>, à la racine du repository,  dans le répertoire (à respecter scrupuleusement, c’est comme ça que Github sait qu’il s’agit d’un workflow d’actions à exécuter!) : <em>.github/workflows/workflow.yml</em></p>\n<p>Dans ce fichier, on va déclarer nos actions afin de compiler et déployer dans Azure. Voici les différentes actions qu’on va utiliser :</p>\n<ul>\n<li><em>actions/checkout@master</em> pour que le workflow accède au repository;</li>\n<li><em>actions/setup-java@v1</em> pour mettre en place un environnement JAVA pour le workflow, afin de construire le JAR;</li>\n<li><em>azure/webapps-deploy@v2</em> : les informations de connexion pour faire le déploiement vers Azure. Il faudra notamment indiquer :\n<ul>\n<li>le nom de l’instance <em>App Service</em> déclaré dans la première étape;</li>\n<li>le <em>profile</em> déclaré dans la partie <em>Création du secret</em> ci-dessus;</li>\n<li><em>package</em> : indique le chemin vers le JAR.</li>\n</ul>\n</li>\n</ul>\n<p>On va également déclarer une partie <em>env</em> pour y déclarer toutes nos propriétés utiles.</p>\n<p>Voici le fichier au complet pour une appli Spring Boot Classique <a href=\"https://github.com/Azure-Samples/java-spring-petclinic\">Pet clinic</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy Java app to Azure Web App\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> push\n\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">AZURE_WEBAPP_NAME</span><span class=\"token punctuation\">:</span> sharebook\n  <span class=\"token key atrule\">AZURE_WEBAPP_PACKAGE_PATH</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.workspace <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">JAVA_VERSION</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'1.11'</span>\n  <span class=\"token key atrule\">AZURE_WEBAPP_PUBLISH_PROFILE</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.AZURE_WEBAPP_PUBLISH_PROFILE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build-and-deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Deploy\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@master\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up JDK 1.8\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>java@v1\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">java-version</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.JAVA_VERSION <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build with Maven\n      <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> mvn package <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>file pom.xml\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Deploy to Azure WebApp'</span>\n      <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> azure/webapps<span class=\"token punctuation\">-</span>deploy@v2\n      <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span> \n        <span class=\"token key atrule\">app-name</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.AZURE_WEBAPP_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">publish-profile</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.AZURE_WEBAPP_PUBLISH_PROFILE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">package</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/target/*.jar'</span></code></pre></div>\n<p>L’ensemble du code source est acessible sur mon github ici : <a href=\"https://github.com/smaestri/sharebook\">https://github.com/smaestri/sharebook</a></p>","frontmatter":{"title":"Déployer une appli Spring-Boot vers le Cloud avec Azure App Services et les Github Actions","date":"February 21, 2021","description":null}},"previous":{"fields":{"slug":"/2021-03-14-react-and-spring-boot/"},"frontmatter":{"title":"Intégrer un frontend React à Spring-Boot"}},"next":{"fields":{"slug":"/2020-12-10- Brancher Jest à Sonar/"},"frontmatter":{"title":"Brancher Sonar à Jest pour afficher la couverture de code du frontend"}}},"pageContext":{"id":"eaae743d-0ba5-52d1-a7e1-57ed2be2762d","previousPostId":"914f88ea-dffc-598c-9a94-fcc24e8f0c1c","nextPostId":"74e3dc12-939a-5440-b45f-0cd53cc9de31"}},"staticQueryHashes":["2841359383","916993862"],"slicesMap":{}}